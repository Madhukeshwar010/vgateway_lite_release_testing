<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>MQTT Setup & Client</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0; padding: 0; overflow: auto;
    }
    body {
      background: #f9f9f9;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: Arial, sans-serif;
    }
    .container {
      background: #f2f2f2;
      padding: 30px 40px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      text-align: center;
      width: 500px;
    }
    label, input, button {
      display: block;
      margin: 10px auto;
      font-size: 16px;
    }
    button {
      padding: 8px 16px;
      font-weight: bold;
      cursor: pointer;
    }
    #certificates {
      display: none;
      text-align: left;
    }
    ul {
      list-style: none;
      padding: 0;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ccc;
      text-align: left;
      margin-top: 20px;
      background: white;
      border-radius: 5px;
    }
    li {
      padding: 5px;
      border-bottom: 1px solid #eee;
      font-family: monospace;
      font-size: 14px;
    }
    pre {
      margin: 0;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .section {
      display: none;
    }
    .section.active {
      display: block;
    }
  </style>
</head>
<body>

<div class="container">
  <!-- Setup Section -->
  <div id="setupSection" class="section active">
    <h2>MQTT Connection Setup</h2>
    <label>Gateway MAC ID:</label>
    <input type="text" id="mac" />

    <label>Broker IP:</label>
    <input type="text" id="broker" placeholder="e.g., 176.9.144.238" />

    <label>Port:</label>
    <input type="number" id="port" placeholder="e.g., 8083 or 8883" />

    <label><input type="checkbox" id="ssl" /> Use SSL</label>

    <div id="certificates">
      <label>CA Certificate (PEM):</label>
      <input type="file" id="ca" accept=".crt,.pem" />
      <label>Client Certificate (PEM):</label>
      <input type="file" id="cert" accept=".crt,.pem" />
      <label>Client Key (PEM):</label>
      <input type="file" id="key" accept=".key,.pem" />
    </div>

    <button id="goToMQTT">MQTT Request</button>
    <button id="goToLTE">LTE Request</button>
    <button id="goToWiFi">Wi-Fi Request</button>
    <button id="goToCB">CB Request</button>
  </div>

  <!-- Sections -->
  <div id="mqttSection" class="section">
    <h2>Available MQTT Request</h2>
    <button id="MQTTRead">MQTT Read Request</button>
    <ul id="mqttMessages"></ul>
    <button onclick="backToSetup()">â¬… Back</button>
  </div>

  <div id="lteSection" class="section">
    <h2>Available LTE Request</h2>
    <button id="LTERead">LTE Read Request</button>
    <ul id="lteMessages"></ul>
    <button onclick="backToSetup()">â¬… Back</button>
  </div>

  <div id="wifiSection" class="section">
    <h2>Available Wi-Fi Request</h2>
    <button id="WIFIRead">Wi-Fi Read Request</button>
    <ul id="wifiMessages"></ul>
    <button onclick="backToSetup()">â¬… Back</button>
  </div>

  <div id="cbSection" class="section">
    <h2>Available CB Request</h2>
    <button id="CBRead">vSens Settings Read Request</button>
    <ul id="CBMessages"></ul>
    <button onclick="backToSetup()">â¬… Back</button>
  </div>
</div>

<script>
window.onload = function() {
  const sslCheckbox = document.getElementById('ssl');
  const certDiv = document.getElementById('certificates');
  sslCheckbox.addEventListener('change', () => {
    certDiv.style.display = sslCheckbox.checked ? 'block' : 'none';
  });

  const sections = {
    setup: document.getElementById('setupSection'),
    mqtt: document.getElementById('mqttSection'),
    lte: document.getElementById('lteSection'),
    wifi: document.getElementById('wifiSection'),
    cb: document.getElementById('cbSection')
  };

  let brokerConfig = null;
  let ws = null;

  function readFileAsync(file) {
    return new Promise((resolve, reject) => {
      if (!file) return resolve(null);
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsText(file);
    });
  }

  function collectConfig() {
    const broker = document.getElementById('broker').value.trim();
    const port = document.getElementById('port').value.trim();
    const mac = document.getElementById('mac').value.trim();
    const useSSL = sslCheckbox.checked;
    if (!broker || !port || !mac) {
      alert('Please enter MAC, Broker IP, and Port.');
      return false;
    }
    brokerConfig = { broker, port, mac, useSSL };
    return true;
  }

  function switchSection(target) {
    Object.values(sections).forEach(s => s.classList.remove('active'));
    sections[target].classList.add('active');
  }

  window.backToSetup = function() {
    switchSection('setup');
    ['mqttMessages','lteMessages','wifiMessages','CBMessages'].forEach(id => {
      document.getElementById(id).innerHTML = '';
    });
  };

  async function connectAndSubscribe() {
    let ca = null, cert = null, key = null;
    if (brokerConfig.useSSL) {
      ca = await readFileAsync(document.getElementById('ca').files[0]);
      cert = await readFileAsync(document.getElementById('cert').files[0]);
      key = await readFileAsync(document.getElementById('key').files[0]);
    }
    ws = new WebSocket('ws://localhost:8080');

    ws.onopen = () => {
      ws.send(JSON.stringify({
        type: 'config',
        broker: brokerConfig.broker,
        port: brokerConfig.port,
        useSSL: brokerConfig.useSSL,
        ca, cert, key
      }));
      ws.send(JSON.stringify({
        type: 'subscribe',
        topic: [`GatewayReply/${brokerConfig.mac}/#`]
      }));
      logMsg(`âœ… Connected to broker`, 'mqtt');
      logMsg(`ðŸ”” Subscribed to GatewayReply/${brokerConfig.mac}/#`, 'mqtt');
    };

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      let displayMsg = data.message || JSON.stringify(data);

      // Try to pretty-print if JSON
      try {
        const parsed = typeof displayMsg === 'string' ? JSON.parse(displayMsg) : displayMsg;
        displayMsg = JSON.stringify(parsed, null, 2);
      } catch (e) {
        // Not JSON, leave as is
      }

      // Show in all sections with formatted output
      ['mqtt', 'lte', 'wifi', 'cb'].forEach(type => {
        logMsg(`ðŸ“© ${data.topic || ''}:\n${displayMsg}`, type, true);
      });
    };
  }

  function publishMessage(topic, type) {
    if (!ws || ws.readyState !== WebSocket.OPEN) {
      alert('WebSocket not connected');
      return;
    }
    ws.send(JSON.stringify({ type: 'publish', topic, message: '{}' }));
    logMsg(`ðŸ“¤ Sent to ${topic}: {}`, type);
  }

  function logMsg(msg, type, isFormatted = false) {
    const map = {
      mqtt: 'mqttMessages',
      lte: 'lteMessages',
      wifi: 'wifiMessages',
      cb: 'CBMessages'
    };
    const ul = document.getElementById(map[type]);
    if (!ul) return;
    const li = document.createElement('li');
    if (isFormatted) {
      li.innerHTML = `<pre>${msg}</pre>`;
    } else {
      li.textContent = msg;
    }
    ul.appendChild(li);
    ul.scrollTop = ul.scrollHeight;
  }

  // Navigation buttons
  document.getElementById('goToMQTT').addEventListener('click', () => {
    if (collectConfig()) { connectAndSubscribe(); switchSection('mqtt'); }
  });
  document.getElementById('goToLTE').addEventListener('click', () => {
    if (collectConfig()) { connectAndSubscribe(); switchSection('lte'); }
  });
  document.getElementById('goToWiFi').addEventListener('click', () => {
    if (collectConfig()) { connectAndSubscribe(); switchSection('wifi'); }
  });
  document.getElementById('goToCB').addEventListener('click', () => {
    if (collectConfig()) { connectAndSubscribe(); switchSection('cb'); }
  });

  // Request buttons
  document.getElementById('MQTTRead').addEventListener('click', () => {
    publishMessage(`ServerRequest/${brokerConfig.mac}/VegamMQTT/ReadJsonFile`, 'mqtt');
  });
  document.getElementById('LTERead').addEventListener('click', () => {
    publishMessage(`ServerRequest/${brokerConfig.mac}/LTE/ReadJsonFile`, 'lte');
  });
  document.getElementById('WIFIRead').addEventListener('click', () => {
    publishMessage(`ServerRequest/${brokerConfig.mac}/WiFi/ReadJsonFile`, 'wifi');
  });
  document.getElementById('CBRead').addEventListener('click', () => {
    publishMessage(`ServerRequest/${brokerConfig.mac}/CB_MODE/ReadJsonFile`, 'cb');
  });
};
</script>
</body>
</html>
